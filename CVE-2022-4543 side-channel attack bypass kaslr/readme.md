## åŸç†

### kpti

- KPTI(Kernel PageTable Isolation)å…¨ç§°å†…æ ¸é¡µè¡¨éš”ç¦»ã€‚åœ¨ [KPTI æœºåˆ¶](https://ctf-wiki.org/pwn/linux/kernel-mode/defense/isolation/user-kernel/kpti/)ä¸­ï¼Œå†…æ ¸æ€ç©ºé—´çš„å†…å­˜å’Œç”¨æˆ·æ€ç©ºé—´çš„å†…å­˜çš„éš”ç¦»è¿›ä¸€æ­¥å¾—åˆ°äº†å¢å¼ºã€‚
    - å†…æ ¸æ€ä¸­çš„é¡µè¡¨åŒ…æ‹¬ç”¨æˆ·ç©ºé—´å†…å­˜çš„é¡µè¡¨å’Œå†…æ ¸ç©ºé—´å†…å­˜çš„é¡µè¡¨ã€‚
    - ç”¨æˆ·æ€çš„é¡µè¡¨åªåŒ…æ‹¬ç”¨æˆ·ç©ºé—´å†…å­˜çš„é¡µè¡¨ä»¥åŠå¿…è¦çš„å†…æ ¸ç©ºé—´å†…å­˜çš„é¡µè¡¨ï¼Œå¦‚ç”¨äºå¤„ç†ç³»ç»Ÿè°ƒç”¨ã€ä¸­æ–­ç­‰ä¿¡æ¯çš„å†…å­˜ã€‚

åœ¨æ²¡æœ‰ kpti ä¹‹å‰ï¼Œå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´éƒ½æ˜¯å­˜åœ¨åŒä¸€ä¸ªé¡µè¡¨ä¸­ï¼Œè¿™æ ·åšçš„å¥½å¤„æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æ•ˆç‡é«˜ï¼Œä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„æ—¶å€™ä¸éœ€è¦åˆ‡æ¢é¡µè¡¨ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ï¼Œæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜å°±æ˜¯å†…æ ¸å’Œç”¨æˆ·æ€çš„éš”ç¦»å˜å¼±äº†ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·æ€å°±èƒ½é€šè¿‡ä¾§ä¿¡é“ç­‰ä¸€ç³»åˆ—æ‰‹æ®µè·å¾—å†…æ ¸æ€çš„ä¸€äº›ä¿¡æ¯ï¼Œè¿›è€Œå¯¹å†…æ ¸è¿›è¡Œæ”»å‡»ã€‚

### prefetch

ç¡¬ä»¶é¢„å–ï¼šåœ¨ä¸€å®šçš„ç­–ç•¥è¢«è§¦å‘æ—¶ï¼ŒCPU å°†è¿›è¡Œç¡¬ä»¶é¢„å–ï¼Œå°†æ•°æ®æŒ‰ç…§ä¸åŒçš„ç­–ç•¥åŠ è½½åˆ°ä¸åŒå±‚çº§çš„ Cache å½“ä¸­ã€‚

è½¯ä»¶é¢„å–ï¼šé€šè¿‡ç¨‹åºå‘˜æ‰‹åŠ¨æˆ–ç¼–è¯‘å™¨è‡ªåŠ¨åœ¨ä»£ç ä¸­æ’å…¥é¢„å–æŒ‡ä»¤ï¼Œä»è€Œå‘ CPU å‘é€é¢„å–æç¤ºï¼Œè®© CPU è¿›è¡Œæ•°æ®é¢„å–ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ€§èƒ½ã€‚x64 æ¶æ„ CPU ä½¿ç”¨ PREFETCHh ç±»æŒ‡ä»¤ï¼ˆPREFETCHT0ï½T2ã€PREFETCHNTAï¼‰ä½œä¸ºé¢„å–æŒ‡ä»¤ï¼Œå®ƒåŒ…å«åœ¨ SSE æŒ‡ä»¤é›†å½“ä¸­ï¼Œå‡ ä¹æ‰€æœ‰ Intel CPU éƒ½æ”¯æŒ SSE æŒ‡ä»¤é›†ã€‚PREFETCHh ç±»æŒ‡ä»¤å»ºè®® CPU åŠ è½½æ•°æ®åˆ° Cache å½“ä¸­ï¼Œä¸”è¯¥ç±»æŒ‡ä»¤ä¸éœ€è¦ç‰¹æƒï¼Œæ‰§è¡Œå¤±è´¥ä¹Ÿä¸ä¼šå¯¼è‡´å¼‚å¸¸ã€‚

x86_64 æœ‰ä¸€ç»„é¢„å–æŒ‡ä»¤ `prefetch` ï¼Œè¿™äº›æŒ‡ä»¤å¯ä»¥å°†æŒ‡å®šåœ°å€é¢„å–åˆ°`cpu cache`(L1,L2,L3 cache)ä¸­ï¼Œå½“ç„¶è¿™ä¸ªåœ°å€ä¹Ÿä¼šè¢«åˆ·æ–°åˆ° å¿«è¡¨tlb(translation lookaside buffer) ä¸­ï¼Œå¦‚æœå°†è¦é¢„å–çš„åœ°å€å·²ç»å­˜åœ¨åœ¨ tlb ä¸­äº†ï¼ˆå°±æ˜¯ä¹‹å‰ä½¿ç”¨è¿‡è¿™ä¸ªåœ°å€ï¼‰ï¼Œé‚£ä¹ˆé¢„å–å°†ä¼šå¿«é€Ÿå®Œæˆï¼Œä½†æ˜¯å½“åœ°å€ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œé¢„å–æŒ‡ä»¤å°†ä¼šå®Œæˆçš„æ¯”è¾ƒæ…¢ï¼ˆè¿™å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºä¹‹å‰æ²¡æœ‰è®¿é—®è¿‡ï¼‰æ‰€ä»¥åœ°å€å¯¹åº”çš„ pte(page table entry) ä¸åœ¨ tlb ä¸­ï¼Œæ‰€ä»¥è¿˜å¾—éå†é¡µè¡¨æ‰¾åˆ°ç‰©ç†åœ°å€ç„¶åæŠŠå¯¹åº”åœ°å€æ•°æ®æ‹·è´åˆ°cpu cache,ä¸­ï¼Œæ¯”ä¹‹å‰è€…å¤šäº†ä¸¤æ­¥æ“ä½œ

### side-channel attack

åœ¨è®¡ç®—æœºå®‰å…¨ä¸­ï¼Œä¾§ä¿¡é“æ”»å‡»æ˜¯åŸºäºè®¡ç®—æœºåè®®æˆ–ç®—æ³•çš„åŸºæœ¬å®ç°æ–¹å¼è€Œå¯ä»¥æ”¶é›†çš„é¢å¤–ä¿¡æ¯çš„æ”»å‡»ï¼Œè€Œä¸æ˜¯åŸºäºæ¼æ´æˆ–ç®—æ³•æœ¬èº«ã€‚æ—¶é—´ä¿¡æ¯ã€åŠŸè€—ã€ç”µç£æ³„æ¼å’Œå£°éŸ³ç­‰éƒ½å¯ä»¥ä½œä¸ºé¢å¤–ä¿¡æ¯ï¼Œç”¨äºæ—é“æ”»å‡»çš„è¿›è¡Œï¼š

ç¼“å­˜æ”»å‡»ï¼šåŸºäºæ”»å‡»è€…ç›‘è§†å—å®³è€…åœ¨è™šæ‹ŸåŒ–ç¯å¢ƒæˆ–äº‘æœåŠ¡ç±»å‹çš„å…±äº«ç‰©ç†ç³»ç»Ÿä¸­è¿›è¡Œç¼“å­˜è®¿é—®çš„èƒ½åŠ›çš„æ”»å‡»ã€‚
è®¡æ—¶æ”»å‡»ï¼šåŸºäºæµ‹é‡å„ç§è®¡ç®—ï¼ˆä¾‹å¦‚å°†æ”»å‡»è€…çš„ç»™å®šå¯†ç ä¸å—å®³è€…çš„æœªçŸ¥å¯†ç è¿›è¡Œæ¯”è¾ƒï¼‰æ‰§è¡Œçš„æ—¶é—´çš„æ”»å‡»ã€‚
æ•°æ®æ®‹ç•™ï¼šæ•æ„Ÿæ•°æ®åœ¨è¢«åˆ é™¤åè¢«è¯»å–ã€‚

æµ‹ä¿¡é“æ”»å‡»çš„ä¾‹å­
1. Attackerå…ˆé€šè¿‡Flushæ¸…ç©ºå¯¹åº”çš„cache line
2. è§¦å‘Victimè®¿é—®è¯¥æ•°æ®
3. Attackerä¼šè®¿é—®åŒä¸€æ•°æ®å¹¶æµ‹é‡è®¿é—®æ—¶é—´

### Meltdown & Spectre CPU æ¼æ´

>Meltdownå¯¹åº”CVE-2017-5754ï¼ˆä¹±åºæ‰§è¡Œç¼“å­˜æ±¡æŸ“ï¼‰ï¼ŒSpectreå¯¹åº”CVE-2017-5753ï¼ˆè¾¹ç•Œæ£€æŸ¥ç»•è¿‡ï¼‰ä¸CVE-2017-5715ï¼ˆåˆ†æ”¯ç›®æ ‡æ³¨å…¥ï¼‰ã€‚
> åœ¨æ¼æ´çº°æ¼å‡ºæ¥æ—¶ï¼ŒMeltdownæ¼æ´å½±å“å‡ ä¹æ‰€æœ‰çš„Intel CPUå’Œéƒ¨åˆ†ARM CPUï¼Œè€ŒSpectreåˆ™å½±å“æ‰€æœ‰çš„Intel CPUå’ŒAMD CPUï¼Œä»¥åŠä¸»æµçš„ARM CPUã€‚AMDä¸å—Meltdownçš„å½±å“ã€‚

Meltdownæ”»å‡»æ˜¯ä¸€ç§ç›´æ¥é’ˆå¯¹åº•å±‚ç¡¬ä»¶æœºåˆ¶ï¼ˆCPUçš„ä¹±åºæ‰§è¡Œæœºåˆ¶ã€Cacheæœºåˆ¶å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶ï¼‰çš„æ—¶é—´ä¾§ä¿¡é“æ”»å‡»ã€‚

#### ä¹±åºæ‰§è¡Œ

ä¹±åºæ‰§è¡Œï¼ˆout-of-order executionï¼‰æ˜¯æŒ‡ CPU é‡‡ç”¨äº†å…è®¸å°†å¤šæ¡æŒ‡ä»¤ä¸æŒ‰ç¨‹åºè§„å®šçš„é¡ºåºåˆ†å¼€å‘é€ç»™å„ç›¸åº”ç”µè·¯å•å…ƒå¤„ç†çš„æŠ€æœ¯ã€‚è¯¥æŠ€æœ¯æé«˜äº† CPU çš„è¿è¡Œç¨‹åºçš„é€Ÿåº¦ã€‚

Meltdownæ”»å‡»çš„æœ¬è´¨æ˜¯åˆ©ç”¨CPUè¿›è¡Œçš„å®‰å…¨æ£€æŸ¥å’Œä¹±åºæ‰§è¡Œä¹‹é—´çš„race conditionï¼Œç»™æ”»å‡»è€…åˆ›é€ ä¸€ä¸ªå¾ˆçŸ­çš„æ”»å‡»çª—å£ã€‚ä¹±åºæ‰§è¡Œæ˜¯æŒ‡å½“CPUä¸­çš„æŸäº›æŒ‡ä»¤éœ€è¦ç­‰å¾…æŸäº›èµ„æºï¼Œæ¯”å¦‚å†…å­˜è¯»å–æ—¶ï¼ŒCPUä¸ä¼šåœ¨å½“å‰æŒ‡ä»¤åœæ­¢ï¼Œè€Œæ˜¯åˆ©ç”¨ç©ºé—²çš„è®¡ç®—èƒ½åŠ›ç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ã€‚è¿™å¤§å¤§åœ°å¢åŠ äº†è®¡ç®—èƒ½åŠ›çš„åˆ©ç”¨ç‡ï¼Œä»è€Œæå‡äº†CPUæ€§èƒ½ã€‚åœ¨æ”¯æŒä¹±åºæ‰§è¡Œçš„CPUä¸Šï¼ŒæŒ‡ä»¤çš„æ‰§è¡Œå¹¶ä¸æ˜¯é¡ºåºè¿›è¡Œçš„ã€‚æ¯”å¦‚åé¢çš„æŒ‡ä»¤å¯èƒ½åœ¨å‰é¢æŒ‡ä»¤æ‰§è¡Œç»“æŸä¹‹å‰å°±å¼€å§‹æ‰§è¡Œã€‚ç„¶è€Œï¼Œä¸ºäº†ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§ï¼ŒæŒ‡ä»¤é€€ä¼‘ï¼ˆretirementï¼‰å¿…é¡»æ˜¯é¡ºåºè¿›è¡Œçš„ï¼Œè€ŒCPUçš„å®‰å…¨æ£€æŸ¥æ˜¯åœ¨æŒ‡ä»¤é€€ä¼‘æ—¶æ‰ä¼šè¿›è¡Œã€‚è¿™æ ·çš„ç»“æœæ˜¯ï¼Œåœ¨CPUå¯¹æŸä¸€æ¡æŒ‡ä»¤è¿›è¡Œå®‰å…¨æ£€æŸ¥ä¹‹å‰ï¼Œä¸€éƒ¨åˆ†åœ¨è¯¥æŒ‡ä»¤åé¢çš„æŒ‡ä»¤ä¼šç”±äºCPUçš„ä¹±åºæ‰§è¡Œè€Œè¢«æå‰æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä¸€æ¡ç”¨æˆ·ç©ºé—´çš„æŒ‡ä»¤è®¿é—®å†…æ ¸å†…å­˜ä¼šå¯¼è‡´CPUæŠ›å‡ºå¼‚å¸¸ï¼Œç„¶è€Œè¯¥å¼‚å¸¸åªæœ‰åœ¨è¿™æ¡æŒ‡ä»¤é€€ä¼‘çš„æ—¶å€™æ‰ä¼šè¢«CPUå¤„ç†ï¼Œè€Œç”±äºä¹±åºæ‰§è¡Œè€Œè¢«æå‰æ‰§è¡Œçš„æŒ‡ä»¤ä¼šè¢«CPUä¸¢å¼ƒã€‚ç”±äºCPUä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œä¹±åºæ‰§è¡Œæœ¬ä¸ä¼šäº§ç”Ÿå®‰å…¨éšæ‚£ã€‚ç„¶è€Œï¼Œç”±äºä¹±åºæ‰§è¡Œçš„æŒ‡ä»¤å¯¹ç¼“å­˜çš„æ“ä½œåœ¨è¿™äº›æŒ‡ä»¤è¢«ä¸¢å¼ƒæ—¶ä¸ä¼šè¢«é‡ç½®ï¼Œæ”»å‡»è€…å°±å¯ä»¥é€šè¿‡ç¼“å­˜ä¾§ä¿¡é“çš„æ–¹å¼æ¥è·å–è¿™äº›ä¹±åºæ‰§è¡Œçš„ä¿¡æ¯ï¼Œä»è€Œå¯¼è‡´äº†Meltdownæ”»å‡»ã€‚æœ¬è´¨ä¸Šï¼ŒSpectreæ”»å‡»çš„åŸç†ä¹Ÿæ˜¯ä¸€æ ·çš„

#### é¢„æµ‹æ‰§è¡Œ

CPUåŸºäºå…ˆæœ‰ç»éªŒé¢„å…ˆæ‰§è¡Œäº†åç»­å¯èƒ½æ‰§è¡Œçš„ä»£ç ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªå¾ªç¯ä¸­çš„ä»£ç å¾ªç¯äº†å¾ˆå¤šæ¬¡å°±æœ‰äº†â€˜ç»éªŒâ€™ã€‚

Spectreæ”»å‡»åˆ©ç”¨äº†CPUçš„é¢„æµ‹æ‰§è¡Œå¯¹ç³»ç»Ÿè¿›è¡Œæ”»å‡»ã€‚é¢„æµ‹æ‰§è¡Œæ˜¯å¦å¤–ä¸€ç§CPUä¼˜åŒ–ç‰¹æ€§ã€‚åœ¨åˆ†æ”¯æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œç”±äºåˆ†æ”¯æŒ‡ä»¤æ‰§è¡Œå¯èƒ½éœ€è¦å†…å­˜è¯»å–ï¼ˆä¸Šç™¾ä¸ªCPUå‘¨æœŸï¼‰ï¼Œåœ¨åˆ†æ”¯æŒ‡ä»¤æ‰§è¡Œç»“æŸä¹‹å‰ï¼ŒCPUä¼šé¢„æµ‹å“ªä¸€ä¸ªåˆ†æ”¯ä¼šè¢«è¿è¡Œï¼Œæå–ç›¸åº”çš„æŒ‡ä»¤ä»£ç å¹¶æ‰§è¡Œï¼Œä»¥æé«˜CPUæŒ‡ä»¤æµæ°´çº¿çš„æ€§èƒ½ã€‚CPUçš„é¢„æµ‹æ‰§è¡Œæ˜¯é€šè¿‡åˆ†æ”¯é¢„æµ‹å•å…ƒ(BPU)è¿›è¡Œçš„ã€‚ç®€å•çš„ç†è§£ï¼ŒBPUå‚¨å­˜äº†æŸä¸ªåˆ†æ”¯æŒ‡ä»¤æœ€è¿‘æ‰§è¡Œè¿‡çš„åˆ†æ”¯è·³è½¬çš„ç»“æœã€‚CPUçš„é¢„æµ‹æ‰§è¡Œé‡åˆ°åˆ†æ”¯æŒ‡ä»¤æ—¶ï¼Œä¼šæ ¹æ®BPUçš„é¢„æµ‹ç»“æœè¿›è¡Œè·³è½¬ã€‚å½“é¢„æµ‹æ‰§è¡Œå‘ç°é¢„æµ‹é”™è¯¯æ—¶ï¼Œé¢„æµ‹æ‰§è¡Œçš„ç»“æœå°†ä¼šè¢«ä¸¢å¼ƒï¼ŒCPUçš„çŠ¶æ€ä¼šè¢«é‡ç½®ã€‚ç„¶è€Œï¼Œä¸ä¹±åºæ‰§è¡Œç±»ä¼¼ï¼Œé¢„æµ‹æ‰§è¡Œå¯¹CPUç¼“å­˜çš„å½±å“ä¼šè¢«ä¿ç•™ã€‚Spectreå’ŒMeltdownæ”»å‡»åœ¨è¿™ä¸€ç‚¹ä¸Šæ¯”è¾ƒç±»ä¼¼ã€‚

### exploit

åœ¨å¼€å¯ KPTI æ—¶ï¼šç”¨æˆ·æ€çš„é¡µè¡¨åªåŒ…æ‹¬ç”¨æˆ·ç©ºé—´å†…å­˜çš„é¡µè¡¨ä»¥åŠå¿…è¦çš„å†…æ ¸ç©ºé—´å†…å­˜çš„é¡µè¡¨ï¼Œå¦‚ç”¨äºå¤„ç†ç³»ç»Ÿè°ƒç”¨ã€ä¸­æ–­ç­‰ä¿¡æ¯çš„å†…å­˜ã€‚ä½†è¿™äº›ä»åŒ…æ‹¬åœ¨ç”¨æˆ·æ€é¡µè¡¨ä¸­çš„å†…æ ¸ç©ºé—´å†…å­˜çš„é¡µè¡¨å´æ²¡æœ‰è¿›è¡ŒéšæœºåŒ–ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨å…¶åœ¨å†…æ ¸ä¸­çš„å®é™…åœ°å€æ˜ å°„åˆ°äº†ç”¨æˆ·ç©ºé—´ã€‚

è¿™ä¸€è¡Œä¸ºå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¾§ä¿¡é“æ”»å‡»æ¥æ³„æ¼ç›¸å…³å†…æ ¸å‡½æ•°çš„å®é™…åœ°å€ã€‚å½“ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°†ä»æ˜ å°„åœ¨ç”¨æˆ·ç©ºé—´çš„ entry_SYSCALL_64 å†…æ ¸å‡½æ•°åŠ è½½åˆ° CPU cache å½“ä¸­ã€‚åœ¨è¿™ä¸ªæ—¶å€™ï¼Œé€šè¿‡ prefetch æŒ‡ä»¤å»é¢„å–ç›¸å…³ç©ºé—´åœ°å€ä»¥è¯•å›¾å‘½ä¸­è¯¥æ¡ cacheï¼Œå¦‚æœå‘½ä¸­çš„è¯ï¼Œå› ä¸ºç›¸å…³æ•°æ®å·²ç»é¢„å–åˆ° CPU çš„ cache å½“ä¸­äº†ï¼Œå› æ­¤è€—æ—¶åº”è¯¥æ˜¯æœ€å°çš„ã€‚æˆ‘ä»¬é€šè¿‡æ—¶é—´çš„è®¡ç®—æ¥è·å¾—åœ°å€

## å¤ç°

- Intel çš„ CPUï¼Œæˆ‘ä»¬æ”»å‡»çš„ç‚¹æ˜¯cacheç¼“å­˜ã€‚
- å†…æ ¸è¦å¼€å¯kaslr å’Œ KPTIï¼Œä¸€èˆ¬éƒ½å¼€å¯äº†ï¼Œå¦‚æœæ˜¯qemuå¯åŠ¨è‡ªè¡Œæ·»åŠ ã€‚

æœ¬æœºæ˜¯AMD CPUï¼Œä½œè€…æ–‡ç« ä¸­ä¹Ÿè¯´æ˜ AMD çš„ CPU æ— æ³•æˆåŠŸğŸ‘€ã€‚
```txt
Iâ€™ve managed to have this work on multiple Intel CPUs (including i5-8265U, i7-8750H,  i7-9700F, i7-9750H, Xeon(R) CPU E5-2640) - I got it working on some VPS instances too but was unable to figure out the Intel CPU model there. It seems to work across a wide range of kernel versions with KPTI - Iâ€™ve tested it on Arch 6.0.12-hardened1-1-hardened, Ubuntu 5.15.0-56-generic, 6.0.12-1-MANJARO, 5.10.0-19-amd64, and a custom 5.18.3 build. It also works in KVM guests to leak the guest OS KASLR base (one would need to forward the host CPU features with "-cpu host" in QEMU for prefetch to even work though). I'm not sure how the TLB side-effects are preserved in a VM scenario though across CR3 writes and potential VM exits - if anyone has ideas, please let me know! As of now, I donâ€™t think this attack affects AMD, but I also don't have direct access to any AMD hardware (see edit in the end). Lastly, I don't believe the repeated syscalls are necessary in my exploit as later tests show that it worked without making them with each measurement most likely due to the global bit, but I still kept it in my exploit just to guarantee its existence in the TLB.
```

- ä½¿ç”¨intel cpuäº‘ä¸»æœºã€‚
    - ä¸ç®¡è·‘å‡ éè„šæœ¬ï¼ŒKASLR base æ˜¯å›ºå®šçš„åœ°å€ã€‚
    - é‡å¯åï¼Œç›¸åŒæœºå™¨å¾—åˆ°çš„åç§»ç›¸åŒã€‚

- æ ·æœ¬æ¯”è¾ƒå°‘
    - å¯èƒ½ä¼šæ ¹æ®èŠ¯ç‰‡çš„ä¸åŒäº§ç”Ÿå˜åŒ–ã€‚
    - å¯èƒ½å› æ“ä½œç³»ç»Ÿè€Œäº§ç”Ÿå˜åŒ–
    - qemuå¯åŠ¨äº§ç”Ÿçš„ç»“æœä¼šä¸ä¼šä¸åŒ

- é‡å¯å¤šå°è¯•ï¼Œå¯ä»¥çœ‹å‡ºæœ‰ä¸€å®šçš„ç¼“è§£ï¼Œä½†æ˜¯ä¸å¤šï¼Œå› ä¸ºåç§»æ˜¯å›ºå®šçš„ï¼ˆé‡å¯ä¹Ÿæ˜¯ï¼‰ï¼Œåœ¨å…·ä½“çš„æ¼æ´åˆ©ç”¨å¯ä»¥å°è¯•ä¸€ä¸‹çˆ†ç ´è·å¾—åŸºå€ã€‚

1. ubuntu20 
```bash
### poc 1
KASLR base 0xffffffffa0600000
root@vultr:~# grep startup_64 /proc/kallsyms
ffffffff9fe00000 T startup_64
>>> hex(0xffffffffa0600000-0xffffffff9fe00000)
'0x800000'

### poc 2
KASLR base 0xffffffff97400000
root@vultr:/home/ubuntu# grep startup_64 /proc/kallsyms
ffffffff96c00000 T startup_64
>>> hex(0xffffffff97400000-0xffffffff96c00000)
'0x800000'
```

2. ubuntu22 
```bash
### poc 1
KASLR base 0xffffffff98800000
root@vultr:/home/ubuntu# grep startup_64 /proc/kallsyms
ffffffff97e00000 T startup_64
>>> hex(0xffffffff98800000-0xffffffff97e00000)
'0xa00000'

### poc 2
KASLR base 0xffffffff8d200000
root@vultr:/home/ubuntu# grep startup_64 /proc/kallsyms
ffffffff8c800000 T startup_64
>>> hex(0xffffffff8d200000-0xffffffff8c800000)
'0xa00000'
```

3. ubuntu23 
```bash
### poc 1
KASLR base 0xffffffff9e600000
root@vultr:/home/ubuntu# grep startup_64 /proc/kallsyms
ffffffff9d800000 T startup_64
>>> hex(0xffffffff9e600000-0xffffffff9d800000)
'0xe00000'

### poc 2
KASLR base 0xffffffff90400000
root@vultr:/home/ubuntu# grep startup_64 /proc/kallsyms
ffffffff8f600000 T startup_64
>>> hex(0xffffffff90400000-0xffffffff8f600000)
'0xe00000'
```

## ä¿®å¤

ä½œè€…æŠ«éœ²äº `12/18/2022`ã€‚æ ¹æ®ä¸Šé¢çš„ç»“æœï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨ï¼Œè¯¯å·®æ¯”è¾ƒå°ã€‚

ä½†æ˜¯é˜…è¯»ä¸€ä¸‹è¿™ä¸ª[exploit.c](https://github.com/bcoles/kasld/blob/master/src/entrybleed.c)ï¼Œåœ¨ kernel 6.2 patchã€‚å¹¶ä¸”æ­¤è„šæœ¬è§£å†³äº†æˆ‘ä»¬ä¸Šé¢åç§»è·å–çš„é—®é¢˜ã€‚


## å‚è€ƒæ–‡ç« 

[Will's Root entrybleed](https://www.willsroot.io/2022/12/entrybleed.html)
[CVE-2022-4543åˆ†æ&å¤ç°](https://sunichi.github.io/2022/12/25/CVE-2022-4543/)
[CVE-2022-4543åŠkptiæœºåˆ¶](https://cainiao159357.github.io/2023/02/08/CVE-2022-4543%E5%8F%8Akpti%E6%9C%BA%E5%88%B6/)
[meltdoen & spectre](https://meltdownattack.com/)
[meltdown & spectreåˆ†æ](https://zhuanlan.zhihu.com/p/263081764)