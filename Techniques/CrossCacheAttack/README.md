## Cross Cache Attack

>é’ˆå¯¹ buddy system çš„ä¸€ç§åˆ©ç”¨æ‰‹æ®µ,æ¯”è¾ƒç¨³å®šçš„ä¸€ç§æŠ€å·§

- slub allocator åº•å±‚é€»è¾‘æ˜¯å‘ buddy system è¯·æ±‚é¡µé¢åå†åˆ’åˆ†æˆç‰¹å®šå¤§å° object è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…
- å†…å­˜ä¸­ç”¨ä½œä¸åŒ kmem_cache çš„é¡µé¢åœ¨å†…å­˜ä¸Šæ˜¯æœ‰å¯èƒ½ç›¸é‚»çš„
- è‹¥æˆ‘ä»¬çš„æ¼æ´å¯¹è±¡å­˜åœ¨äºé¡µé¢ Aï¼Œæº¢å‡ºç›®æ ‡å¯¹è±¡å­˜åœ¨äºé¡µé¢ Bï¼Œä¸” Aã€Bä¸¤é¡µé¢ç›¸é‚»ï¼Œåˆ™æˆ‘ä»¬ä¾¿æœ‰å¯èƒ½å®ç°è·¨è¶Šä¸åŒ kmem_cache ä¹‹é—´çš„å †æº¢å‡º

ä¹Ÿå°±æ˜¯ç‰©ç†é¡µ A,B ç›¸é‚»ï¼Œåˆ†ç»™äº†ä¸åŒçš„ cacheã€‚åœ¨ cache-A ä¸­ æº¢å‡º A ä¼šå¯¼è‡´Bä¼šè¢«ä¿®æ”¹ã€‚

**ä¸åŒçš„cacheå¯ä»¥å…³è”èµ·æ¥ï¼Œå¯¼è‡´å‡ ä¹ä»»æ„å¤§å°çš„å †åˆ†é…**

### page-level heap fengshui

é¡µçº§å †é£æ°´å³ä»¥**å†…å­˜é¡µä¸ºç²’åº¦**çš„å†…å­˜æ’å¸ƒæ–¹å¼ï¼Œè€Œå†…æ ¸å†…å­˜é¡µçš„æ’å¸ƒå¯¹æˆ‘ä»¬æ¥è¯´ä¸ä»…æœªçŸ¥ä¸”ä¿¡æ¯é‡å·¨å¤§ï¼Œå› æ­¤è¿™ç§åˆ©ç”¨æ‰‹æ³•å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬æ‰‹å·¥æ„é€ ä¸€ä¸ªæ–°çš„å·²çŸ¥çš„é¡µçº§ç²’åº¦å†…å­˜é¡µæ’å¸ƒ

1. å‘ buddy system è¯·æ±‚ä¸¤ä»½è¿ç»­çš„å†…å­˜é¡µ
2. é‡Šæ”¾å…¶ä¸­ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ vulnerable kmem_cache ä¸Šå †å–·ï¼Œè®©å…¶ç”³è¯·èµ°è¿™ä»½å†…å­˜é¡µ
3. é‡Šæ”¾å¦ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ victim kmem_cache ä¸Šå †å–·ï¼Œè®©å…¶ç”³è¯·è¿™ä»½å†…å­˜é¡µ

### ç”³è¯·è¿ç»­å†…å­˜é¡µ

#### socket ring buffer

0. æ¶ˆè€—å®Œbyddy system æ‰€æœ‰ **orderæ¯”è¾ƒå°** çš„é¡µï¼Œæ–¹ä¾¿å†æ¬¡ç”³è¯·æ—¶åˆ‡å‰²ï¼Œå¾—åˆ°è¿ç»­çš„å†…å­˜
1. å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª protocol ä¸º `PF_PACKET` çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ `setsockopt()` å°† PACKET_VERSION è®¾ä¸º TPACKET_V1 / TPACKET_V2ï¼Œå†è°ƒç”¨ setsockopt() æäº¤ä¸€ä¸ª PACKET_TX_RING ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾

```cpp
__sys_setsockopt()
    sock->ops->setsockopt()
    	packet_setsockopt() // case PACKET_TX_RING â†“
    		packet_set_ring()
    			alloc_pg_vec()
```

2. alloc_pg_vec
- pg_vec kcalloc block_nr ä¸ªç»“æ„ä½“
- order ç”± tp_block_size å†³å®š

```cpp
static struct pgv *alloc_pg_vec(struct tpacket_req *req, int order)
{
	unsigned int block_nr = req->tp_block_nr;
	struct pgv *pg_vec;
	int i;

	pg_vec = kcalloc(block_nr, sizeof(struct pgv), GFP_KERNEL | __GFP_NOWARN);
	if (unlikely(!pg_vec))
		goto out;

	for (i = 0; i < block_nr; i++) {
		pg_vec[i].buffer = alloc_one_pg_vec_page(order);
		if (unlikely(!pg_vec[i].buffer))
			goto out_free_pgvec;
	}

out:
	return pg_vec;

out_free_pgvec:
	free_pg_vec(pg_vec, order, block_nr);
	pg_vec = NULL;
	goto out;
}
```

3. åœ¨ alloc_one_pg_vec_page() ä¸­ä¼šç›´æ¥è°ƒç”¨ __get_free_pages() å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°è¿›è¡Œå¤§é‡çš„é¡µé¢è¯·æ±‚

```cpp
static char *alloc_one_pg_vec_page(unsigned long order)
{
	char *buffer;
	gfp_t gfp_flags = GFP_KERNEL | __GFP_COMP |
			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;

	buffer = (char *) __get_free_pages(gfp_flags, order);
	if (buffer)
		return buffer;
	//...
}
```

4. pgv ä¼šåœ¨ socket ç»“æŸåfree

```cpp
packet_release()
    packet_set_ring()
    	free_pg_vec()
```

pgv ä¸­çš„é¡µé¢ä¼šåœ¨ socket è¢«å…³é—­åé‡Šæ”¾ï¼Œè¿™ä¹Ÿæ–¹ä¾¿æˆ‘ä»¬åç»­çš„é¡µçº§å †é£æ°´ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä½æƒé™ç”¨æˆ·æ— æ³•ä½¿ç”¨è¯¥å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å¼€è¾Ÿæ–°çš„å‘½åç©ºé—´æ¥ç»•è¿‡è¯¥é™åˆ¶

#### io_uring

åŒç†ï¼Œæˆ‘ä»¬æŒ‰ç…§ `__get_free_pages` å‡½æ•°ç»§ç»­æ‰¾ï¼Œå¯ä»¥æ‰¾åˆ°å¦ä¸€ä¸ªè°ƒç”¨é“¾

```cpp
void *io_mem_alloc(size_t size)
{
	gfp_t gfp = GFP_KERNEL_ACCOUNT | __GFP_ZERO | __GFP_NOWARN | __GFP_COMP;
	void *ret;

	ret = (void *) __get_free_pages(gfp, get_order(size));
	if (ret)
		return ret;
	return ERR_PTR(-ENOMEM);
}
```

é¡ºç€æ‰¾: io_uring order åˆ†é…

```cpp
io_uring_setup : p from user.
	io_uring_create : p => io_uring_param __user *p
		io_allocate_scq_urings: size => io_uring_param *p
```

free: å¯ä»¥çœ‹åˆ°è¿”å›å€¼ä¸º rings 

```cpp
static void io_rings_free(struct io_ring_ctx *ctx)
{
	if (!(ctx->flags & IORING_SETUP_NO_MMAP)) {
		io_mem_free(ctx->rings);
		io_mem_free(ctx->sq_sqes);
		ctx->rings = NULL;
		ctx->sq_sqes = NULL;
	} else {
		io_pages_free(&ctx->ring_pages, ctx->n_ring_pages);
		ctx->n_ring_pages = 0;
		io_pages_free(&ctx->sqe_pages, ctx->n_sqe_pages);
		ctx->n_sqe_pages = 0;
	}
}
```

æœ€åæ‰¾åˆ°äº† releaseï¼Œä½†æ˜¯å¦‚ä½•åˆ©ç”¨?

```cpp
io_uring_release
	io_ring_ctx_wait_and_kill
		io_ring_exit_work
			io_ring_ctx_free
				io_rings_free
```

## Exploit

### UAF example

- ä¸»è¦å‚è€ƒ[è¿™ä¸€ç¯‡æ–‡ç« ](https://veritas501.github.io/2023_03_07-Cross%20Cache%20Attack%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90/)ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç†è§£è¿™ä¸ªæ¼æ´åˆ©ç”¨æ–¹å¼ã€‚

1. æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯
```bash
$ sudo cat /sys/kernel/slab/filp/object_size 			# æ¯ä¸ªfilp objectçš„å¤§å°
256
$ sudo cat /sys/kernel/slab/filp/slab_size        # ä½¿ç”¨å¤šå¤§çš„slab
256
$ sudo cat /sys/kernel/slab/filp/objs_per_slab 		# æ¯ä¸ª slab ç”³è¯· object æœ€å¤§å€¼
32
$ sudo cat /sys/kernel/slab/filp/cpu_partial 			# cpu partial list é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°
52
```

2. å †å–·å°„ï¼Œæ¸…ç©ºç›®æ ‡cacheåœ¨kernelä¸­çš„å†…å­˜ç¢ç‰‡ã€‚
3. ç”³è¯·(cpu_partial + 1) * objs_per_slab ä¸ªobject
- åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œè¿™äº›objectä¼šæ­£å¥½æ”¾åœ¨ 53 ä¸ªslabä¸­ï¼›ç”±äºå¤šæ•°æƒ…å†µä¸‹åœ¨ç”³è¯·objectå‰ï¼Œå¤šå¤šå°‘å°‘ä¼šæœ‰å‡ ä¸ªobjectå·²ç»å ç”¨äº†ä¸€ä¸ªslabï¼Œå› æ­¤æˆ‘ä»¬çš„objectä¼šåˆ†å¸ƒäº54ä¸ªslabä¸­ï¼Œä¸”ç¬¬54ä¸ªslabéæ»¡ã€‚
- ç›®å‰åªè€ƒè™‘å¤šæ•°æƒ…å†µ
4. ç”³è¯· objs_per_slab - 1 = 31 ä¸ªobjectï¼Œä»è€Œä½¿54ä¸ªslabæ»¡
5. ç”³è¯·ä¸€ä¸ªæ¼æ´object(vuln)ï¼Œåç»­ç”¨æ¥UAF, è¿™ä¸ªvuln objectåœ¨ 55 ä¸ª slab ä¸­
6. ç”³è¯· objs_per_slab + 1 = 33 ä¸ªobjectï¼Œç¡®ä¿ vuln slab æ»¡ï¼Œå¹¶åˆ›é€ ç¬¬56ä¸ªslab
7. è§¦å‘æ¼æ´objectçš„UAF,ä¹Ÿå°±æ˜¯freeæ‰ vuln object
- ç”±äºæ¼æ´objectæ‰€åœ¨çš„slabæ˜¯æ»¡çš„ï¼Œå› æ­¤ä¼šè§¦å‘ put_cpu_partial()ï¼Œä½†ç”±äº cpu partial list éæ»¡ï¼Œæ‰€ä»¥ç°åœ¨è¿˜ä¸ä¼šè¿›å…¥unfreeze_partials()ã€‚
8. æˆ‘ä»¬å°† vuln å‰åå„ objs_per_slab ä¸ªobjecté‡Šæ”¾ï¼Œä»è€Œè®©ç¬¬ 55 slabè¿›å…¥å…¨ç©ºçŠ¶æ€, 54, 57 å…¨éƒ¨partial
å› ä¸ºè™½ç„¶å†…æ ¸å¯èƒ½å¼€äº†freelist hardenå’Œfreelist randomä¿æŠ¤ï¼Œä½†ä»pageçš„è§’åº¦æ¥è¯´ï¼Œä¾ç„¶æ˜¯é¡ºåºçš„ã€‚å› æ­¤å‰åå„objs_per_slab = 16ä¸ªobjecté‡Šæ”¾å°±èƒ½è®©ç¬¬16ä¸ªslabè¿›å…¥å…¨ç©ºçŠ¶æ€ã€‚ï¼ˆå½“ç„¶è¿™ä¹Ÿä¼šå¯¼è‡´ç¬¬15å’Œç¬¬17ä¸ªslabè¿›å…¥åŠç©ºçŠ¶æ€ï¼Œä¸è¿‡è¿™ä¸å½±å“ï¼‰
> åœ¨ç¬¬55ä¸ªslabç¬¬ä¸€æ¬¡ä»å…¨æ»¡è¿›å…¥åŠæ»¡æ—¶ï¼Œå°±ä¼šè§¦å‘put_cpu_partial()å°†å…¶æ”¾å…¥ cpu partial listä¸­ã€‚ä¹‹åç›´åˆ°å…¨ç©ºéƒ½ä¸ä¼šå†è¿›å…¥put_cpu_partial()ã€‚
9. å°†1-53ä¸ªslabä¸­å„é‡Šæ”¾ä¸€ä¸ªobjectï¼Œå°†å…¶ä»å…¨æ»¡çŠ¶æ€è¿›å…¥åŠæ»¡çŠ¶æ€
è¿™å°†å¯¹æ¯ä¸ªpageè§¦å‘ä¸€æ¬¡put_cpu_partial()ã€‚ç”±äº53 = cpu_partial + 1ï¼Œå› æ­¤è¿™å¿…å°†å¯¼è‡´æœ€åå‡ æ¬¡åœ¨è¿›å…¥put_cpu_partial()æ—¶å‘ç°cpu partial listæ»¡äº†ï¼Œä»è€Œè¿›å…¥unfreeze_partials()é€»è¾‘ã€‚ç„¶åå‘ç°ç¬¬16ä¸ªslabå·²ç»è¿›å…¥äº†å…¨ç©ºçŠ¶æ€ï¼Œä»è€Œè°ƒç”¨discard_slab()å°†è¿™ä¸ªpageè¿›è¡Œé‡Šæ”¾ã€‚
10. è¿™æ ·åœ¨æ–°è·å¾—çš„pageä¸­ï¼Œå­˜åœ¨ uaf, å¯ä»¥ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚

ç®€åŒ–ä¸€ä¸‹
- heap spray æ¸…ç©ºslab ä¸­çš„ç¢ç‰‡ï¼Œè¿™æ ·å°±å¯ä»¥å‘ buddy system ç”³è¯·
- buddy system ç”³è¯· page, å…¶ä¸­ä¸€ä¸ª object: vuln heap
- å¡«æ»¡ page, ç„¶ååœ¨ spray ä¸€ä¸‹
- free vuln heap
- free vuln å‰åä½¿ page è¿›å…¥ buddy system
- spray victim è·å¾— vuln page, é€šè¿‡ vuln ä¿®æ”¹victim

### heap overflow

>ç»“åˆä¸Šé¢çš„ é¡µçº§å †é£æ°´è¿›è¡Œåˆ©ç”¨

- pipe_bufver ç»“æ„ä½“çš„å¼€å¤´å°±å­˜åœ¨ page æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä¿®æ”¹å…¶pageæŒ‡é’ˆï¼Œè®©ä¸¤ä¸ªpipeçš„pageæŒ‡å‘ç›¸åŒä½ç½®,å°±åƒ CVE-2021-22555 é‚£ç§åˆ©ç”¨æ–¹å¼ä¸€æ ·ï¼ŒåŒæ—¶pipeä¹Ÿèƒ½ä»»æ„è¯»å†™ï¼Œç¾æ»‹æ»‹ğŸ˜‹

## å‚è€ƒé“¾æ¥

- [N1CTF Praymoon](https://blog.imv1.me/2022/11/10/N1CTF-2022-Praymoon-Write-Up/)
- [Linux kernel 6.2 source](https://elixir.bootlin.com/linux/v6.2.16/source)
- [d3ctf](https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/)
- [cross cache overflow](https://paper.seebug.org/1889/)