## ç¼–è¯‘é€‰é¡¹

å½±å“ç‰ˆæœ¬ï¼šLinux v2.6.19-rc1~v5.12-rc7 v5.12-rc8å·²ä¿®è¡¥ï¼Œæ¼æ´å­˜åœ¨äº†15å¹´ï¼Œè¯„åˆ†7.8ã€‚ å·²ä¿®å¤çš„ç‰ˆæœ¬æœ‰ 5.12ï¼Œ5.10.31, 5.4.113, 4.19.188, 4.14.231, 4.9.267, 4.4.267ã€‚ ç”±syzkallerå‘ç°

- ä¸»è¦é é˜…è¯»[æ­¤ç¯‡æ–‡ç« ](https://bsauce.github.io/2021/09/23/CVE-2021-22555/)å­¦ä¹ ï¼Œåœ¨ä½œè€…çš„githubæä¾›äº†[ä½œè€…çš„config](https://github.com/bsauce/kernel-exploit-factory/blob/main/CVE-2021-22555/config)æ–‡ä»¶ï¼Œç›´æ¥æŠ„ä¸€ä»½ã€‚ä¿®æ”¹ç¼–è¯‘å™¨ç‰ˆæœ¬

- æˆ–è€…menuconfigåœ¨ç½‘ç»œé€‰é¡¹ä¸­å°†netfilterç›¸å…³é€‰é¡¹å…¨éƒ¨å‹¾é€‰ã€‚
```config
CONFIG_IP_NF_** å…¨ä¸ºy
CONFIG_NETFILTER_** å…¨éƒ¨ä¸º `y`
CONFIG_E1000å’ŒCONFIG_E1000Eï¼Œå˜æ›´ä¸º=y

CONFIG_USER_NS=y
CONFIG_NET_NS=y
CONFIG_COMPAT=y
```

- `pahole` å·¥å…·ç‰ˆæœ¬é—®é¢˜ï¼Œä¸èƒ½è¿‡é«˜å’Œè¿‡ä½ã€‚ğŸ¤£ ubuntu18/20æ¯”è¾ƒé€‚åˆã€‚

## å¤§è‡´åŸç†

- è¯¦æƒ…ï¼ˆåŒ…æ‹¬å‚è€ƒæ–‡ç« ï¼‰è¯·è§[pdf](./study.pdf)

`net/netfilter/x_tables.c` ä¸­ Netfilter æ¨¡å—çš„ip_tableså­æ¨¡å—ï¼Œ å½“è°ƒç”¨setsockopt()å’Œé€‰é¡¹IPT_SO_SET_REPLACEï¼ˆæˆ– IP6T_SO_SET_REPLACEï¼‰æ—¶ï¼Œåœ¨32ä½è½¬åŒ–ä¸º64ä½æ—¶è®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´åœ¨è°ƒç”¨ xt_compat_match_from_user() å‡½æ•°æ—¶ **å †æº¢å‡ºå†™ 0**ã€‚
å†åˆ©ç”¨æ—¶å¯èƒ½ä¼šé€ æˆäº›è®¸çš„æ•°æ®åå·®ï¼Œåˆ°æœ€ååˆ©ç”¨å°±æ—¶**ä¸¤å­—èŠ‚å †æº¢å‡ºå†™0**ã€‚

## exploit

å†…æ ¸å¼€å¯ kaslr,smap,smep,kptiã€‚

### heap overflow to uaf

1. åˆ›å»º0x1000ä¸ªä¸»ä»æ¶ˆæ¯ï¼Œä¸»æ¶ˆæ¯0x1000, ä»æ¶ˆæ¯0x400ã€‚å…ˆå¡«å……ä¸»æ¶ˆæ¯ï¼Œåå¡«å……ä»æ¶ˆæ¯
2. é‡Šæ”¾1024ï¼Œ2048ï¼Œ3096çš„ä¸»æ¶ˆæ¯
3. è§¦å‘å †æº¢å‡ºï¼Œå°†é‡Šæ”¾çš„æŸä¸ªæ¶ˆæ¯çš„ `msg_msg->m_list->next` æœ«å°¾ä¸¤å­—èŠ‚ä¿®æ”¹ä¸º0ï¼ŒæŒ‡å‘å…¶ä½™æ¶ˆæ¯ï¼Œé€ æˆä¸¤ä¸ªæ¶ˆæ¯æŒ‡å‘åŒä¸€ä¸ªå †
4. å®šä½å ä½çš„æ¶ˆæ¯
5. ä¸»æ¶ˆæ¯1é‡Šæ”¾ä»æ¶ˆæ¯ï¼Œç„¶åä½¿ç”¨skbå ä½ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨ä¸»æ¶ˆæ¯2ä¿®æ”¹å…¶ä¸­çš„å†…å®¹ã€‚ä½†æ˜¯åœ¨é‡Šæ”¾æ¶ˆæ¯æ—¶éœ€è¦**ç¡®ä¿ä»æ¶ˆæ¯çš„æŒ‡é’ˆä¸ä¼šå‡ºé”™æ‰è¡Œï¼ˆfree_msgçš„æ“ä½œï¼‰**

### msg_msg ä¿®å¤

1. é¿å…msg_msg å´©æºƒ(msgrcvä¼šfreeæ‰ï¼Œè¿›è¡ŒåŒé“¾è¡¨çš„unlinkï¼Œè¿›è¡ŒæŒ‡é’ˆçš„æ£€æŸ¥)ï¼Œéœ€è¦leakå‡ºmsg_msgçš„prevå’ŒnextæŒ‡é’ˆã€‚ä½†æ˜¯æ£€æŸ¥ä¸ä¸¥æ ¼ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œåªéœ€è¦ä¿è¯nextã€prevæŒ‡é’ˆæ‰€æŒ‡å‘å†…å­˜åœ°å€å¯å†™å³å¯
2. æ³„éœ²è¾…åŠ©æ¶ˆæ¯åœ°å€
3. æ³„éœ²ä¸»æ¶ˆæ¯åœ°å€


### bypass kaslr

- ä½¿ç”¨ pipe_buffer->ops ä¸­çš„ç»“æ„ä½“ leak 

### ROP

- close pipe æ—¶ä¼šè°ƒç”¨ `pipe_buffer->ops->release`
- bypass smep, smap, kptiï¼Œç›´æ¥å‘å†…æ ¸å †(secondary_msg 0x400 è¶³å¤Ÿçš„)ä¸­ä½¿ç”¨sk_buffå†™å…¥ropé“¾


- åˆ«äººè°ƒè¯•æ—¶ï¼Œå‡½æ•°è°ƒç”¨ï¼ŒrsiæŒ‡å‘pipe_bufferåœ°å€
1. mov rspï¼Œrsiå°†æ ˆè½¬ç§»åˆ°æˆ‘ä»¬çš„ropï¼ˆpipe_buffer ä¸‹é¢ï¼‰ä¸­ã€‚
2. add rsp, xxx
3. push rsi; pop rsp


## å¤ç°

èŠ±äº†å¾ˆé•¿æ—¶é—´ï¼Œæœ€åæ²¡æœ‰æˆåŠŸğŸ˜­ğŸ˜­ğŸ˜­ï¼Œé‚æ”¾å¼ƒ

## summary

æ­¤æ¼æ´çš„åˆ©ç”¨ç¡®å®æ‰“å¼€å†…æ ¸heap overflow å’Œ use after freeçš„æ€è·¯ï¼Œå¯ä»¥heap overflow è½¬åŒ–ä¸º uafï¼Œè¿›è€Œåˆ©ç”¨
